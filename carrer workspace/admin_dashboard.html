<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin — CareerPath</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <header class="navbar">
      <div class="logo">CareerPath — Admin</div>
      <div class="nav-links">
        <a href="login.html" id="logout">Logout</a>
      </div>
    </header>

    <div class="grid-2 container" style="margin-top:20px">
      <aside class="side card">
        <div class="avatar">
          <img src="https://avatars.dicebear.com/api/adventurer/admin.svg" alt="admin">
          <div>
            <div class="username">Administrator</div>
            <div class="meta">Manage tests • View student eligibility</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <button class="btn btn-primary" id="addDemoQ">Add Demo Question</button>
          <button class="btn btn-ghost" id="clearAll" style="margin-left:8px">Clear All Results</button>
        </div>

        <div style="margin-top:14px">
          <h4 class="h2">Eligibility Thresholds</h4>
          <div id="thresholdsWrap"></div>
          <div style="margin-top:8px">
            <button class="btn" id="saveThresholds">Save Thresholds</button>
          </div>
        </div>
      </aside>

      <main>
        <div class="card">
          <h3 class="h2">Question Bank</h3>
          <div id="questionsList"></div>

          <div style="margin-top:12px">
            <h4 class="p-muted">Add Question</h4>
            <div class="form-row"><label>Question text</label><input id="newQtext" type="text" placeholder="Type question..."></div>
            <div class="form-row"><label>Category mapping (Agree → category)</label>
              <select id="mapAgree"><option value="tech">Tech</option><option value="creative">Creative</option><option value="business">Business</option><option value="social">Social</option></select>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn btn-primary" id="addQbtn">Add Question</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:16px">
          <h3 class="h2">Student Results</h3>
          <table class="table" id="resultsTbl">
            <thead><tr><th>Student</th><th>Top Domain</th><th>Score (%)</th><th>Date</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </main>
    </div>

    <footer class="footer">Admin panel — All changes saved to browser localStorage</footer>
  </div>

<script>
  // protect admin route
  if(sessionStorage.getItem('role')!=='admin'){ alert('Not logged in as admin'); window.location='login.html'; }

  function loadQuestions(){
    const box = document.getElementById('questionsList'); box.innerHTML='';
    const qs = JSON.parse(localStorage.getItem('questions')||'[]');
    qs.forEach((q,i)=>{
      const div = document.createElement('div'); div.className='qcard';
      div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>${i+1}.</strong> ${q.text}</div>
        <div><button class="btn" data-i="${i}" onclick="removeQ(${i})">Delete</button></div>
      </div>
      <div style="margin-top:8px;color:var(--muted);font-size:0.92rem">Agree -> ${q.category[0]}, Neutral -> ${q.category[1]}, Disagree -> ${q.category[2]}</div>`;
      box.appendChild(div);
    });
  }

  function removeQ(i){
    const qs = JSON.parse(localStorage.getItem('questions')||'[]'); qs.splice(i,1);
    localStorage.setItem('questions', JSON.stringify(qs)); loadQuestions();
  }

  document.getElementById('addQbtn').addEventListener('click', ()=>{
    const text = document.getElementById('newQtext').value.trim();
    const agreeCat = document.getElementById('mapAgree').value;
    if(!text){ alert('Enter question text'); return; }
    const qs = JSON.parse(localStorage.getItem('questions')||'[]');
    const id = qs.length? (qs[qs.length-1].id+1):1;
    // mapping agree->selected, neutral & disagree default to neutral & other
    const neutral = 'neutral';
    const disagree = (agreeCat==='tech')? 'business' : (agreeCat==='creative')? 'tech' : 'tech';
    qs.push({id:id, text:text, options:['Agree','Neutral','Disagree'], category:[agreeCat, neutral, disagree]});
    localStorage.setItem('questions', JSON.stringify(qs));
    document.getElementById('newQtext').value=''; loadQuestions();
  });

  document.getElementById('addDemoQ').addEventListener('click', ()=>{
    const qs = JSON.parse(localStorage.getItem('questions')||'[]');
    qs.push({id:Date.now(), text:"I enjoy exploring futuristic tech and gadgets.", options:['Agree','Neutral','Disagree'], category:['tech','neutral','creative']});
    localStorage.setItem('questions', JSON.stringify(qs));
    loadQuestions();
  });

  function loadResultsTable(){
    const tbody = document.querySelector('#resultsTbl tbody'); tbody.innerHTML='';
    const students = JSON.parse(localStorage.getItem('students')||'[]');
    students.forEach(s=>{
      (s.results||[]).forEach(r=>{
        const tr = document.createElement('tr'); tr.className='row-highlight';
        tr.innerHTML = `<td>${s.name||s.username}</td><td>${r.top}</td><td>${r.score}</td><td>${new Date(r.date).toLocaleString()}</td>`;
        tbody.appendChild(tr);
      });
    });
  }

  // thresholds UI
  function loadThresholds(){
    const wrap = document.getElementById('thresholdsWrap'); wrap.innerHTML='';
    const t = JSON.parse(localStorage.getItem('thresholds')||'{}');
    for(const k of ['tech','creative','business','social']){
      const div = document.createElement('div'); div.className='form-row';
      div.innerHTML = `<label>${k.toUpperCase()} threshold (%)</label><input type="text" data-key="${k}" value="${t[k]||0}">`;
      wrap.appendChild(div);
    }
  }

  document.getElementById('saveThresholds').addEventListener('click', ()=>{
    const inputs = document.querySelectorAll('#thresholdsWrap input');
    const t = {};
    inputs.forEach(i=> t[i.dataset.key] = Number(i.value)||0);
    localStorage.setItem('thresholds', JSON.stringify(t));
    alert('Thresholds saved.');
  });

  document.getElementById('clearAll').addEventListener('click', ()=>{
    if(confirm('Clear all student results?')) {
      const students = JSON.parse(localStorage.getItem('students')||'[]');
      students.forEach(s=> s.results=[]);
      localStorage.setItem('students', JSON.stringify(students));
      loadResultsTable();
      alert('Cleared.');
    }
  });

  document.getElementById('logout').addEventListener('click', ()=>{ sessionStorage.clear(); });

  // initial load
  loadQuestions(); loadResultsTable(); loadThresholds();
</script>
</body>
</html>
